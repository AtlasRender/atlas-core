name: Update Pathfinder data storage.

on:
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCE_PROJECT }}
  GCE_INSTANCE: ${{ secrets.GCE_INSTANCE_STORAGE }}
  GCE_INSTANCE_ZONE: ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }}
  APPLICATION_CREDENTIALS: ${{secrets.GCE_SA_KEY}}

jobs:
  gcloud: 
    runs-on: ubuntu-latest
    name: Restart data storage services on GCloud
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      # Setup gcloud CLI
      - name: Setup GCloud environment
        uses: GoogleCloudPlatform/github-actions/setup-gcloud@master
        with:
          version: '290.0.1'
          service_account_key: ${{ secrets.GCE_SA_KEY }}
          project_id: ${{ secrets.GCE_PROJECT }}
#       - name: Restart using bash script on server
#         uses: actions-hub/gcloud@master
#         with: 
#           args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} --command='sudo bash "deploy.sh"' ${{secrets.GCE_INSTANCE_STORAGE}}
#           - run: docker stop $(docker ps -a -q)
      - name: Clean up repo directory
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo rm -rf "pathfinder-core"'
      - name: Clone git repository
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo git clone "https://github.com/Pathfinder-Systems/pathfinder-core.git"'
      - name: Update apt-get repository
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo apt-get update -y'
      - name: Install git-crypt
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo apt-get install -y "git-crypt"'
      - name: Install base64 util
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo apt-get install -y "cl-base64"'
      - name: Write git-crypt base64 key from GitHub Secrets to file
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo echo "${{secrets.GIT_CRYPT_KEY_B64}}" > "pathfinder-core/key_base64.txt"'
      - name: decrypt key from base64 to binary
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo base64 -d "pathfinder-core/key_base64.txt" > "pathfinder-core/key"'
      - name: Unlock repository with git-crypt
        uses: actions-hub/gcloud@master
        with:
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'cd "pathfinder-core" && sudo git-crypt unlock "key"'
      - name: Delete old docker-compose scenario.
        uses: actions-hub/gcloud@master
        with: 
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo rm -f "docker-compose.yaml"'
      - name: Move docker-compose configuration file to the root and rename it to docker-compose.yaml
        uses: actions-hub/gcloud@master
        with: 
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo mv "pathfinder-core/docker-compose/pathfinder-data-storage-start.yaml" "docker-compose.yaml"'
      - name: Delete git repository
        uses: actions-hub/gcloud@master
        with: 
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo rm -rf "pathfinder-core"'
#       - name: Stop all containers
#         uses: actions-hub/gcloud@master
#         with: 
#           args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo docker-compose restart'
      - name: Execute scenario as daemons
        uses: actions-hub/gcloud@master
        with: 
          args: compute ssh --zone ${{ secrets.GCE_INSTANCE_STORAGE_ZONE }} ${{secrets.GCE_INSTANCE_STORAGE}} --command 'sudo docker-compose up -d'
